name: HW Lesson 19 Tests with Reports

on:
  push:
    branches: [main, lesson18-19]
    paths:
      - 'hw-lesson-19/**'
      - '.github/workflows/hw-lesson-19.yml'
  pull_request:
    branches: [main]
    paths:
      - 'hw-lesson-19/**'
  workflow_dispatch:

jobs:
  test:
    name: Run Tests with Allure & Mochawesome
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Java (for Allure)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run tests with Allure reporter
        run: npm run test:hw19:allure
        continue-on-error: true

      - name: Generate Allure report
        run: npx allure generate allure-results --clean -o allure-report
        if: always()

      - name: Upload Allure report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30

      - name: Run tests with Mochawesome reporter
        run: |
          npx playwright test --config=hw-lesson-19/playwright.config.ts
        env:
          REPORTER: mochawesome
        continue-on-error: true

      - name: Upload Mochawesome report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mochawesome-report
          path: mochawesome-report/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: hw19-test-results
          path: test-results/
          retention-days: 7

  deploy-reports:
    name: Deploy Reports to GitHub Pages
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      pages: write
      id-token: write

    steps:
      - name: Download Allure report
        uses: actions/download-artifact@v4
        with:
          name: allure-report
          path: public/allure

      - name: Download Mochawesome report
        uses: actions/download-artifact@v4
        with:
          name: mochawesome-report
          path: public/mochawesome

      - name: Create index page
        run: |
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Test Reports - HW Lesson 19</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 40px; background: #1a1a2e; color: #eee; }
              h1 { color: #00d9ff; }
              a { color: #00d9ff; text-decoration: none; font-size: 1.2em; }
              a:hover { text-decoration: underline; }
              .links { margin-top: 30px; }
              .links a { display: block; margin: 15px 0; padding: 15px; background: #16213e; border-radius: 8px; }
            </style>
          </head>
          <body>
            <h1>ðŸ“Š Test Reports - HW Lesson 19</h1>
            <div class="links">
              <a href="./allure/index.html">ðŸ“ˆ Allure Report</a>
              <a href="./mochawesome/mochawesome.html">ðŸ“‹ Mochawesome Report</a>
            </div>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: public/

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

